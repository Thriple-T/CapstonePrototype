{% extends "dashboard/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Your Dashboard</h1>
    <div>
        <a href="{% url 'add_student' %}" class="btn btn-primary">+ Add Student</a>
        <a href="{% url 'add_course' %}" class="btn btn-secondary">+ Add Course</a>
    </div>
</div>

{% if error %}
    <div class="alert alert-danger" role="alert">
        <strong>System Alert:</strong> {{ error }}
    </div>
{% endif %}

<div class="card mb-5">
    <div class="card-header">Enrolled Students</div>
    <div class="card-body">
        {% if students %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Student ID</th>
                        <th>Courses</th>
                        <th>Fees Owed</th>
                        <th>Status</th>
                        <th>Dropout Risk</th>
                        <th>Pred. Grade</th>
                        <th>Pred. Income</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <a href="{% url 'student_detail' student.pk %}" class="fw-bold text-decoration-none">
                                {{ student.first_name }} {{ student.last_name }}
                            </a>
                        </td>
                        <td>{{ student.student_id|default:"-" }}</td>
                        <td>
                            {% for course in student.courses.all %}
                                <span class="badge bg-info text-dark">{{ course.course_code }}</span><br>
                            {% empty %}
                                <span class="text-muted">None</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if student.current_balance > 0 %}
                                <span class="text-danger fw-bold">${{ student.current_balance }}</span>
                            {% else %}
                                <span class="text-success">Paid</span>
                            {% endif %}
                        </td>
                        <td>{{ student.get_status_display }}</td>
                        
                        <td>
                            <span style="color: {{ student.dropout_risk.color }}; font-weight: bold;">
                                {{ student.dropout_risk.label }}
                            </span>
                        </td>
                        <td>{{ student.predicted_grade }}</td>
                        <td>${{ student.predicted_income|floatformat:0 }}</td>

                        <td>
                            <a href="{% url 'add_payment' student.pk %}" class="btn btn-sm btn-success">Pay</a>
                            <a href="{% url 'edit_student' student.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                            <a href="{% url 'student_attendance_history' student.pk %}" class="btn btn-sm btn-info">History</a>
                            <a href="{% url 'student_detail' student.pk %}" class="btn btn-sm btn-outline-info">Detail</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
            <p class="text-center p-4">No students found.</p>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">Active Courses</div>
    <div class="card-body">
        {% if courses %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Course Name</th>
                        <th>Schedule</th>
                        <th>Ends On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for course in courses %}
                    <tr>
                        <td>{{ course.name }}</td>
                        <td>
                            {% if course.schedule_days %}
                                {{ course.schedule_days }} 
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ course.end_date|default:"Ongoing" }}</td>
                        <td>
                            <a href="{% url 'manage_roster' course.pk %}">Roster</a> |
                            <a href="{% url 'take_attendance' course.pk %}">Attendance</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-center">No courses created yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}